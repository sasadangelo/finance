{% extends 'base.html' %}

{% block title %}ETF Manager{% endblock %}

{% block body %}
<div class="container mt-5">
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h2 class="mb-0">
                        Gestione ETF
                        <div class="float-right">
                            <button id="updateAllQuotesBtn" class="btn btn-info" onclick="updateAllQuotes()">
                                <i class="fas fa-sync-alt"></i> Aggiorna Tutte le Quotazioni
                            </button>
                            <a href="{{ url_for('etf.create') }}" class="btn btn-success">
                                <i class="fas fa-plus"></i> Aggiungi ETF
                            </a>
                        </div>
                    </h2>
                </div>
                <div class="card-body">
                    {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                    {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    {% endfor %}
                    {% endif %}
                    {% endwith %}

                    <!-- Progress Bar (hidden by default) -->
                    <div id="progressContainer" class="mb-3" style="display: none;">
                        <div class="card">
                            <div class="card-body">
                                <h5 id="progressTitle">Aggiornamento quotazioni in corso...</h5>
                                <div class="progress" style="height: 25px;">
                                    <div id="progressBar"
                                        class="progress-bar progress-bar-striped progress-bar-animated"
                                        role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0"
                                        aria-valuemax="100">
                                        0%
                                    </div>
                                </div>
                                <p id="progressText" class="mt-2 mb-0 text-muted">Preparazione...</p>
                            </div>
                        </div>
                    </div>

                    <table class="table table-striped table-hover">
                        <thead class="thead-dark">
                            <tr>
                                <th>Ticker</th>
                                <th>Nome</th>
                                <th>ISIN</th>
                                <th>Valuta</th>
                                <th>Volatilità</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if etfs %}
                            {% for etf in etfs %}
                            <tr>
                                <td><strong>{{ etf.ticker }}</strong></td>
                                <td>{{ etf.name }}</td>
                                <td>{{ etf.isin or '-' }}</td>
                                <td>{{ etf.currency or '-' }}</td>
                                <td>{{ etf.volatility or '-' }}</td>
                                <td>
                                    <a href="{{ url_for('etf.show', ticker=etf.ticker) }}" class="btn btn-info btn-sm"
                                        title="Dettagli">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <a href="{{ url_for('etf.edit', ticker=etf.ticker) }}"
                                        class="btn btn-warning btn-sm" title="Modifica">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <form action="{{ url_for('etf.delete', ticker=etf.ticker) }}" method="POST"
                                        style="display:inline;"
                                        onsubmit="return confirm('Sei sicuro di voler eliminare questo ETF?');">
                                        <button type="submit" class="btn btn-danger btn-sm" title="Elimina">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                            {% else %}
                            <tr>
                                <td colspan="6" class="text-center">
                                    <p class="text-muted">Nessun ETF presente nel database.</p>
                                    <a href="{{ url_for('etf.create') }}" class="btn btn-primary">
                                        Aggiungi il primo ETF
                                    </a>
                                </td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Function to update all ETF quotes using Server-Sent Events (SSE)
    function updateAllQuotes() {
        const btn = document.getElementById('updateAllQuotesBtn');
        const originalHtml = btn.innerHTML;
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const progressTitle = document.getElementById('progressTitle');
        const progressText = document.getElementById('progressText');

        // Disable button and show loading state
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Aggiornamento in corso...';

        // Show progress bar
        progressContainer.style.display = 'block';
        progressBar.style.width = '0%';
        progressBar.setAttribute('aria-valuenow', '0');
        progressBar.textContent = '0%';
        progressBar.classList.remove('bg-success', 'bg-warning', 'bg-danger');
        progressBar.classList.add('progress-bar-animated');
        progressTitle.textContent = 'Aggiornamento quotazioni in corso...';
        progressText.textContent = 'Connessione al server...';

        // Create EventSource for SSE
        const eventSource = new EventSource('/etfs/quotes/update-all-stream');
        const failedEtfs = [];

        eventSource.onmessage = function (event) {
            try {
                const data = JSON.parse(event.data);

                // Handle error
                if (data.error) {
                    progressBar.classList.remove('progress-bar-animated');
                    progressBar.classList.add('bg-danger');
                    progressTitle.textContent = 'Errore durante l\'aggiornamento';
                    progressText.textContent = data.message;
                    showAlert('danger', data.message);
                    eventSource.close();
                    btn.disabled = false;
                    btn.innerHTML = originalHtml;
                    return;
                }

                // Handle completion
                if (data.done) {
                    progressBar.classList.remove('progress-bar-animated');

                    if (data.failed_count === 0) {
                        progressBar.classList.add('bg-success');
                        progressTitle.textContent = 'Aggiornamento completato!';
                        progressText.textContent = data.message;
                        showAlert('success', data.message);
                    } else {
                        progressBar.classList.add('bg-warning');
                        progressTitle.textContent = 'Aggiornamento completato con errori';

                        // Build error message
                        let errorMsg = data.message;
                        if (data.failed_etfs && data.failed_etfs.length > 0) {
                            errorMsg += '<br><br><strong>ETF con errori:</strong><ul>';
                            data.failed_etfs.forEach(etf => {
                                errorMsg += `<li>${etf.ticker} (${etf.name}): ${etf.error}</li>`;
                            });
                            errorMsg += '</ul>';
                        }

                        progressText.innerHTML = errorMsg;
                        showAlert('warning', errorMsg);
                    }

                    eventSource.close();
                    btn.disabled = false;
                    btn.innerHTML = originalHtml;

                    // Hide progress bar after 10 seconds
                    setTimeout(() => {
                        progressContainer.style.display = 'none';
                        progressBar.classList.remove('bg-success', 'bg-warning');
                        progressBar.classList.add('progress-bar-animated');
                    }, 10000);

                    return;
                }

                // Update progress bar in real-time
                if (data.progress !== undefined) {
                    progressBar.style.width = data.progress + '%';
                    progressBar.setAttribute('aria-valuenow', data.progress);
                    progressBar.textContent = data.progress + '%';

                    // Update status text
                    const statusIcon = data.status === 'success' ? '✓' : '✗';
                    const statusClass = data.status === 'success' ? 'text-success' : 'text-danger';
                    progressText.innerHTML = `
                        <span class="${statusClass}">${statusIcon}</span>
                        ${data.ticker} (${data.name}): ${data.message}
                        <br><small class="text-muted">Elaborati ${data.current} di ${data.total} ETF</small>
                    `;
                }

            } catch (error) {
                console.error('Error parsing SSE data:', error);
            }
        };

        eventSource.onerror = function (error) {
            console.error('SSE Error:', error);
            progressBar.classList.remove('progress-bar-animated');
            progressBar.classList.add('bg-danger');
            progressTitle.textContent = 'Errore di connessione';
            progressText.textContent = 'Connessione al server interrotta';
            showAlert('danger', 'Errore di connessione al server');
            eventSource.close();
            btn.disabled = false;
            btn.innerHTML = originalHtml;
        };
    }

    // Function to show alert messages
    function showAlert(type, message) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.role = 'alert';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        `;

        const cardBody = document.querySelector('.card-body');
        const firstChild = cardBody.querySelector('.alert, .table');
        if (firstChild) {
            cardBody.insertBefore(alertDiv, firstChild);
        } else {
            cardBody.insertBefore(alertDiv, cardBody.firstChild);
        }

        // Auto-dismiss after 10 seconds
        setTimeout(() => {
            alertDiv.remove();
        }, 10000);
    }
</script>
{% endblock %}