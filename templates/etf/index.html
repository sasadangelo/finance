{% extends 'base.html' %}

{% block title %}ETF Manager{% endblock %}

{% block body %}
<div class="container mt-5">
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h2 class="mb-0">
                        Gestione ETF
                        <div class="float-right">
                            <button id="updateAllQuotesBtn" class="btn btn-info" onclick="updateAllQuotes()">
                                <i class="fas fa-sync-alt"></i> Aggiorna Tutte le Quotazioni
                            </button>
                            <a href="{{ url_for('etf.create') }}" class="btn btn-success">
                                <i class="fas fa-plus"></i> Aggiungi ETF
                            </a>
                        </div>
                    </h2>
                </div>
                <div class="card-body">
                    <!-- Filter Panel (Collapsible) -->
                    <div class="mb-3">
                        <button class="btn btn-warning btn-block" type="button" onclick="toggleFilters()">
                            <i class="fas fa-filter"></i> Filtri di Ricerca {% if has_filters %}<span
                                class="badge badge-light">Attivi</span>{% endif %}
                        </button>
                    </div>

                    <div id="filterPanel" style="{% if not has_filters %}display: none;{% endif %}">
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">
                                    <i class="fas fa-search"></i> Filtra ETF
                                </h5>
                            </div>
                            <div class="card-body">
                                <form method="GET" action="{{ url_for('etf.index') }}">
                                    <div class="row">
                                        <!-- Asset Type Filter -->
                                        <div class="col-md-4 mb-3">
                                            <label for="asset_type" class="form-label">
                                                <i class="fas fa-chart-pie"></i> Tipo di Asset
                                            </label>
                                            <select class="form-control" id="asset_type" name="asset_type">
                                                <option value="">-- Tutti --</option>
                                                {% for asset_type in asset_types %}
                                                <option value="{{ asset_type.value }}" {% if filters.asset_type and
                                                    filters.asset_type.value==asset_type.value %}selected{% endif %}>
                                                    {{ asset_type.value }}
                                                </option>
                                                {% endfor %}
                                            </select>
                                        </div>

                                        <!-- Dividend Type Filter -->
                                        <div class="col-md-4 mb-3">
                                            <label for="dividend_type" class="form-label">
                                                <i class="fas fa-coins"></i> Tipo di Dividendo
                                            </label>
                                            <select class="form-control" id="dividend_type" name="dividend_type">
                                                <option value="">-- Tutti --</option>
                                                {% for div_type in dividend_types %}
                                                <option value="{{ div_type }}" {% if filters.dividend_type==div_type
                                                    %}selected{% endif %}>
                                                    {{ div_type }}
                                                </option>
                                                {% endfor %}
                                            </select>
                                        </div>

                                        <!-- Currency Filter -->
                                        <div class="col-md-4 mb-3">
                                            <label for="currency" class="form-label">
                                                <i class="fas fa-dollar-sign"></i> Valuta
                                            </label>
                                            <select class="form-control" id="currency" name="currency">
                                                <option value="">-- Tutte --</option>
                                                {% for curr in currencies %}
                                                <option value="{{ curr }}" {% if filters.currency==curr %}selected{%
                                                    endif %}>
                                                    {{ curr }}
                                                </option>
                                                {% endfor %}
                                            </select>
                                        </div>

                                        <!-- Replication Type Filter -->
                                        <div class="col-md-4 mb-3">
                                            <label for="replication" class="form-label">
                                                <i class="fas fa-copy"></i> Tipo di Replica
                                            </label>
                                            <select class="form-control" id="replication" name="replication">
                                                <option value="">-- Tutti --</option>
                                                {% for repl in replications %}
                                                <option value="{{ repl }}" {% if filters.replication==repl %}selected{%
                                                    endif %}>
                                                    {{ repl }}
                                                </option>
                                                {% endfor %}
                                            </select>
                                        </div>

                                        <!-- Index Filter -->
                                        <div class="col-md-4 mb-3">
                                            <label for="index_ticker" class="form-label">
                                                <i class="fas fa-chart-line"></i> Indice di Riferimento
                                            </label>
                                            <select class="form-control" id="index_ticker" name="index_ticker">
                                                <option value="">-- Tutti --</option>
                                                {% for idx_ticker in index_tickers %}
                                                <option value="{{ idx_ticker }}" {% if filters.index_ticker==idx_ticker
                                                    %}selected{% endif %}>
                                                    {{ idx_ticker }}
                                                </option>
                                                {% endfor %}
                                            </select>
                                        </div>

                                        <!-- Fund Size Filter -->
                                        <div class="col-md-4 mb-3">
                                            <label for="min_capital" class="form-label">
                                                <i class="fas fa-building"></i> Dimensione Fondo (min)
                                            </label>
                                            <select class="form-control" id="min_capital" name="min_capital">
                                                <option value="">-- Tutte --</option>
                                                <option value="100" {% if filters.min_capital==100 %}selected{% endif
                                                    %}>
                                                    > 100 milioni
                                                </option>
                                                <option value="500" {% if filters.min_capital==500 %}selected{% endif
                                                    %}>
                                                    > 500 milioni
                                                </option>
                                            </select>
                                        </div>

                                        <!-- Age Filter -->
                                        <div class="col-md-4 mb-3">
                                            <label for="min_age_years" class="form-label">
                                                <i class="fas fa-calendar-alt"></i> Età Minima
                                            </label>
                                            <select class="form-control" id="min_age_years" name="min_age_years">
                                                <option value="">-- Tutte --</option>
                                                <option value="1" {% if filters.min_age_years==1 %}selected{% endif %}>
                                                    > 1 anno
                                                </option>
                                                <option value="3" {% if filters.min_age_years==3 %}selected{% endif %}>
                                                    > 3 anni
                                                </option>
                                                <option value="5" {% if filters.min_age_years==5 %}selected{% endif %}>
                                                    > 5 anni
                                                </option>
                                            </select>
                                        </div>
                                    </div>

                                    <div class="row mt-2">
                                        <div class="col-md-12">
                                            <button type="submit" class="btn btn-primary">
                                                <i class="fas fa-search"></i> Cerca
                                            </button>
                                            <a href="{{ url_for('etf.index') }}" class="btn btn-secondary">
                                                <i class="fas fa-redo"></i> Reset Filtri
                                            </a>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                    {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    {% endfor %}
                    {% endif %}
                    {% endwith %}

                    <!-- Results Header -->
                    {% if has_filters %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>{{ etfs|length }} ETF</strong> trovati con i filtri selezionati
                    </div>
                    {% endif %}

                    <!-- Progress Bar (hidden by default) -->
                    <div id="progressContainer" class="mb-3" style="display: none;">
                        <div class="card">
                            <div class="card-body">
                                <h5 id="progressTitle">Aggiornamento quotazioni in corso...</h5>
                                <div class="progress" style="height: 25px;">
                                    <div id="progressBar"
                                        class="progress-bar progress-bar-striped progress-bar-animated"
                                        role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0"
                                        aria-valuemax="100">
                                        0%
                                    </div>
                                </div>
                                <p id="progressText" class="mt-2 mb-0 text-muted">Preparazione...</p>
                            </div>
                        </div>
                    </div>

                    <table class="table table-striped table-hover">
                        <thead class="thead-dark">
                            <tr>
                                <th>Ticker</th>
                                <th>Nome</th>
                                <th>ISIN</th>
                                <th>Valuta</th>
                                <th>Volatilità</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if etfs %}
                            {% for etf in etfs %}
                            <tr>
                                <td><strong>{{ etf.ticker }}</strong></td>
                                <td>{{ etf.name }}</td>
                                <td>{{ etf.isin or '-' }}</td>
                                <td>{{ etf.currency or '-' }}</td>
                                <td>{{ etf.volatility or '-' }}</td>
                                <td>
                                    <a href="{{ url_for('etf.show', ticker=etf.ticker) }}" class="btn btn-info btn-sm"
                                        title="Dettagli">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <a href="{{ url_for('etf.edit', ticker=etf.ticker) }}"
                                        class="btn btn-warning btn-sm" title="Modifica">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <form action="{{ url_for('etf.delete', ticker=etf.ticker) }}" method="POST"
                                        style="display:inline;"
                                        onsubmit="return confirm('Sei sicuro di voler eliminare questo ETF?');">
                                        <button type="submit" class="btn btn-danger btn-sm" title="Elimina">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                            {% else %}
                            <tr>
                                <td colspan="6" class="text-center">
                                    <p class="text-muted">Nessun ETF presente nel database.</p>
                                    <a href="{{ url_for('etf.create') }}" class="btn btn-primary">
                                        Aggiungi il primo ETF
                                    </a>
                                </td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Function to toggle filter panel
    function toggleFilters() {
        const panel = document.getElementById('filterPanel');
        if (panel.style.display === 'none') {
            panel.style.display = 'block';
        } else {
            panel.style.display = 'none';
        }
    }

    // Function to update all ETF quotes using Server-Sent Events (SSE)
    function updateAllQuotes() {
        const btn = document.getElementById('updateAllQuotesBtn');
        const originalHtml = btn.innerHTML;
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const progressTitle = document.getElementById('progressTitle');
        const progressText = document.getElementById('progressText');

        // Disable button and show loading state
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Aggiornamento in corso...';

        // Show progress bar
        progressContainer.style.display = 'block';
        progressBar.style.width = '0%';
        progressBar.setAttribute('aria-valuenow', '0');
        progressBar.textContent = '0%';
        progressBar.classList.remove('bg-success', 'bg-warning', 'bg-danger');
        progressBar.classList.add('progress-bar-animated');
        progressTitle.textContent = 'Aggiornamento quotazioni in corso...';
        progressText.textContent = 'Connessione al server...';

        // Create EventSource for SSE
        const eventSource = new EventSource('/etfs/quotes/update_all');
        const failedEtfs = [];

        eventSource.onmessage = function (event) {
            try {
                const data = JSON.parse(event.data);

                // Handle error
                if (data.error) {
                    progressBar.classList.remove('progress-bar-animated');
                    progressBar.classList.add('bg-danger');
                    progressTitle.textContent = 'Errore durante l\'aggiornamento';
                    progressText.textContent = data.message;
                    showAlert('danger', data.message);
                    eventSource.close();
                    btn.disabled = false;
                    btn.innerHTML = originalHtml;
                    return;
                }

                // Handle completion
                if (data.done) {
                    progressBar.classList.remove('progress-bar-animated');

                    if (data.failed_count === 0) {
                        progressBar.classList.add('bg-success');
                        progressTitle.textContent = 'Aggiornamento completato!';
                        progressText.textContent = data.message;
                        showAlert('success', data.message);
                    } else {
                        progressBar.classList.add('bg-warning');
                        progressTitle.textContent = 'Aggiornamento completato con errori';

                        // Build error message
                        let errorMsg = data.message;
                        if (data.failed_etfs && data.failed_etfs.length > 0) {
                            errorMsg += '<br><br><strong>ETF con errori:</strong><ul>';
                            data.failed_etfs.forEach(etf => {
                                errorMsg += `<li>${etf.ticker} (${etf.name}): ${etf.error}</li>`;
                            });
                            errorMsg += '</ul>';
                        }

                        progressText.innerHTML = errorMsg;
                        showAlert('warning', errorMsg);
                    }

                    eventSource.close();
                    btn.disabled = false;
                    btn.innerHTML = originalHtml;

                    // Hide progress bar after 10 seconds
                    setTimeout(() => {
                        progressContainer.style.display = 'none';
                        progressBar.classList.remove('bg-success', 'bg-warning');
                        progressBar.classList.add('progress-bar-animated');
                    }, 10000);

                    return;
                }

                // Update progress bar in real-time
                if (data.progress !== undefined) {
                    progressBar.style.width = data.progress + '%';
                    progressBar.setAttribute('aria-valuenow', data.progress);
                    progressBar.textContent = data.progress + '%';

                    // Update status text
                    const statusIcon = data.status === 'success' ? '✓' : '✗';
                    const statusClass = data.status === 'success' ? 'text-success' : 'text-danger';
                    progressText.innerHTML = `
                        <span class="${statusClass}">${statusIcon}</span>
                        ${data.ticker} (${data.name}): ${data.message}
                        <br><small class="text-muted">Elaborati ${data.current} di ${data.total} ETF</small>
                    `;
                }

            } catch (error) {
                console.error('Error parsing SSE data:', error);
            }
        };

        eventSource.onerror = function (error) {
            console.error('SSE Error:', error);
            progressBar.classList.remove('progress-bar-animated');
            progressBar.classList.add('bg-danger');
            progressTitle.textContent = 'Errore di connessione';
            progressText.textContent = 'Connessione al server interrotta';
            showAlert('danger', 'Errore di connessione al server');
            eventSource.close();
            btn.disabled = false;
            btn.innerHTML = originalHtml;
        };
    }

    // Function to show alert messages
    function showAlert(type, message) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.role = 'alert';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        `;

        const cardBody = document.querySelector('.card-body');
        const firstChild = cardBody.querySelector('.alert, .table');
        if (firstChild) {
            cardBody.insertBefore(alertDiv, firstChild);
        } else {
            cardBody.insertBefore(alertDiv, cardBody.firstChild);
        }

        // Auto-dismiss after 10 seconds
        setTimeout(() => {
            alertDiv.remove();
        }, 10000);
    }
</script>
{% endblock %}