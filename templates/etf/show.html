{% extends 'base.html' %}

{% block title %}Dettagli ETF{% endblock %}

{% block body %}
<div class="container mt-5">
    <div class="row">
        <div class="col-md-10 offset-md-1">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h2 class="mb-0">
                        Dettagli ETF: {{ etf.ticker }}
                        <div class="float-right">
                            <a href="{{ url_for('etf.edit', ticker=etf.ticker) }}" class="btn btn-warning btn-sm">
                                <i class="fas fa-edit"></i> Modifica
                            </a>
                            <a href="{{ url_for('etf.index') }}" class="btn btn-secondary btn-sm">
                                <i class="fas fa-arrow-left"></i> Torna alla lista
                            </a>
                        </div>
                    </h2>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h4 class="border-bottom pb-2">Informazioni Generali</h4>
                            <table class="table table-borderless">
                                <tr>
                                    <th width="40%">Ticker:</th>
                                    <td><strong>{{ etf.ticker }}</strong></td>
                                </tr>
                                <tr>
                                    <th>Nome:</th>
                                    <td>{{ etf.name }}</td>
                                </tr>
                                <tr>
                                    <th>ISIN:</th>
                                    <td>{{ etf.isin or '-' }}</td>
                                </tr>
                                <tr>
                                    <th>Data Lancio:</th>
                                    <td>{{ etf.launchDate or '-' }}</td>
                                </tr>
                                <tr>
                                    <th>Tipo Asset:</th>
                                    <td>
                                        {% if etf.assetType %}
                                        {% if etf.assetType.value == 'EQUITY' %}Azionario
                                        {% elif etf.assetType.value == 'BOND' %}Obbligazionario
                                        {% elif etf.assetType.value == 'PRECIOUS_METALS' %}Metalli Preziosi
                                        {% elif etf.assetType.value == 'COMMODITIES' %}Materie Prime
                                        {% elif etf.assetType.value == 'CRYPTOCURRENCY' %}Criptovalute
                                        {% elif etf.assetType.value == 'REAL_ESTATE' %}Immobiliare
                                        {% elif etf.assetType.value == 'MONEY_MARKET' %}Monetario
                                        {% else %}{{ etf.assetType.value }}
                                        {% endif %}
                                        {% else %}-
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <th>Valuta:</th>
                                    <td>{{ etf.currency or '-' }}</td>
                                </tr>
                                <tr>
                                    <th>Replica:</th>
                                    <td>{{ etf.replication or '-' }}</td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h4 class="border-bottom pb-2">Dati Finanziari</h4>
                            <table class="table table-borderless">
                                <tr>
                                    <th width="40%">Capitale (M):</th>
                                    <td>
                                        {% if etf.capital %}
                                        {{ "%.2f"|format(etf.capital) }} M
                                        {% else %}
                                        -
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <th>Volatilità:</th>
                                    <td>
                                        {% if etf.volatility %}
                                        {{ "%.2f"|format(etf.volatility) }}%
                                        {% else %}
                                        -
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <th>Rendimento:</th>
                                    <td>
                                        {% if etf.yeld %}
                                        {{ "%.2f"|format(etf.yeld) }}%
                                        {% else %}
                                        -
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <th>Tipo Dividendo:</th>
                                    <td>{{ etf.dividendType or '-' }}</td>
                                </tr>
                                <tr>
                                    <th>Frequenza Dividendo:</th>
                                    <td>
                                        {% if etf.dividendFrequency == 1 %}
                                        Annuale
                                        {% elif etf.dividendFrequency == 2 %}
                                        Semestrale
                                        {% elif etf.dividendFrequency == 4 %}
                                        Trimestrale
                                        {% elif etf.dividendFrequency == 12 %}
                                        Mensile
                                        {% else %}
                                        -
                                        {% endif %}
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>

                    <!-- Chart Section -->
                    <div class="row mt-4">
                        <div class="col-md-12">
                            <h4 class="border-bottom pb-2">
                                Andamento Quotazioni
                                <button id="updateQuotesBtn" class="btn btn-primary btn-sm float-right"
                                    onclick="updateQuotes()">
                                    <i class="fas fa-sync-alt"></i> Aggiorna Quotazioni
                                </button>
                            </h4>

                            <!-- Period Selector -->
                            <div class="btn-group mb-3" role="group" aria-label="Period selector">
                                <button type="button" class="btn btn-outline-primary btn-sm period-btn"
                                    data-period="5D">5D</button>
                                <button type="button" class="btn btn-outline-primary btn-sm period-btn"
                                    data-period="1M">1M</button>
                                <button type="button" class="btn btn-outline-primary btn-sm period-btn"
                                    data-period="3M">3M</button>
                                <button type="button" class="btn btn-outline-primary btn-sm period-btn"
                                    data-period="6M">6M</button>
                                <button type="button" class="btn btn-outline-primary btn-sm period-btn active"
                                    data-period="1Y">1Y</button>
                                <button type="button" class="btn btn-outline-primary btn-sm period-btn"
                                    data-period="YTD">YTD</button>
                                <button type="button" class="btn btn-outline-primary btn-sm period-btn"
                                    data-period="5Y">5Y</button>
                                <button type="button" class="btn btn-outline-primary btn-sm period-btn"
                                    data-period="Max">Max</button>
                            </div>

                            <!-- Chart Canvas -->
                            <div style="position: relative; height: 400px;">
                                <canvas id="priceChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-4">
                        <div class="col-md-12">
                            <div class="btn-group" role="group">
                                <a href="{{ url_for('etf.edit', ticker=etf.ticker) }}" class="btn btn-warning">
                                    <i class="fas fa-edit"></i> Modifica
                                </a>
                                <form action="{{ url_for('etf.delete', ticker=etf.ticker) }}" method="POST"
                                    style="display:inline;"
                                    onsubmit="return confirm('Sei sicuro di voler eliminare questo ETF?');">
                                    <button type="submit" class="btn btn-danger">
                                        <i class="fas fa-trash"></i> Elimina
                                    </button>
                                </form>
                                <a href="{{ url_for('etf.index') }}" class="btn btn-secondary">
                                    <i class="fas fa-arrow-left"></i> Torna alla lista
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
    let chart = null;
    const ticker = "{{ etf.ticker }}";

    // Function to load chart data
    async function loadChart(period = '1Y') {
        try {
            const response = await fetch(`/etfs/${ticker}/quotes?period=${period}`);
            const data = await response.json();

            if (data.error) {
                console.error('Error loading quotes:', data.error);
                return;
            }

            // Destroy existing chart if it exists
            if (chart) {
                chart.destroy();
            }

            // Create new chart
            const ctx = document.getElementById('priceChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: `${ticker} - Prezzo di Chiusura`,
                        data: data.data,
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.1)',
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function (context) {
                                    return `€${context.parsed.y.toFixed(2)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function (value) {
                                    return '€' + value.toFixed(2);
                                }
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });
        } catch (error) {
            console.error('Error loading chart:', error);
        }
    }

    // Period button click handlers
    document.querySelectorAll('.period-btn').forEach(button => {
        button.addEventListener('click', function () {
            // Remove active class from all buttons
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Add active class to clicked button
            this.classList.add('active');

            // Load chart with selected period
            const period = this.getAttribute('data-period');
            loadChart(period);
        });
    });

    // Load initial chart (1Y)
    loadChart('1Y');

    // Function to update quotes for this ETF
    async function updateQuotes() {
        const btn = document.getElementById('updateQuotesBtn');
        const originalHtml = btn.innerHTML;

        // Disable button and show loading state
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Aggiornamento...';

        try {
            const response = await fetch(`/etfs/${ticker}/quotes/update`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            const result = await response.json();

            if (result.success) {
                // Show success message
                showAlert('success', result.message);

                // Reload chart to show new data
                const activePeriod = document.querySelector('.period-btn.active').getAttribute('data-period');
                loadChart(activePeriod);
            } else {
                showAlert('danger', 'Errore: ' + result.message);
            }
        } catch (error) {
            showAlert('danger', 'Errore durante l\'aggiornamento: ' + error.message);
        } finally {
            // Re-enable button
            btn.disabled = false;
            btn.innerHTML = originalHtml;
        }
    }

    // Function to show alert messages
    function showAlert(type, message) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.role = 'alert';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        `;

        const cardBody = document.querySelector('.card-body');
        cardBody.insertBefore(alertDiv, cardBody.firstChild);

        // Auto-dismiss after 5 seconds
        setTimeout(() => {
            alertDiv.remove();
        }, 5000);
    }
</script>
{% endblock %}